# 视频压缩 App 产品需求文档

**版本**：1.0.0  
**最后更新**：2026-02-28

---

## 一、产品定位

**产品名称**：Video Compressor

**定位**：一款专业、高效的视频压缩工具，支持本地视频批量压缩和压缩历史管理，帮助用户快速减小视频体积，便于分享和存储。

**产品形态**：
- 移动端 App（Android / iOS）
- 桌面端 App（macOS）

**目标用户**：
- 需要压缩视频以便于社交媒体分享的用户
- 存储空间不足需要清理视频的用户
- 视频创作者需要导出不同清晰度版本的用户
- 需要批量处理视频的专业用户

---

## 二、功能清单

### 2.1 核心功能

| 功能 | 优先级 | 代码状态 | 说明 |
|------|--------|----------|------|
| 本地视频压缩 | P0 | ✅ 已实现 | 选择本地视频进行压缩 |
| 批量压缩 | P0 | ✅ 已实现 | 一次选择多个视频加入压缩队列 |
| 压缩质量设置 | P0 | ✅ 已实现 | 低(1Mbps)/中(2.5Mbps)/高(5Mbps)/原始/自定义 |
| 分辨率设置 | P0 | ✅ 已实现 | 720P/1080P/原分辨率/自定义 |
| 压缩进度显示 | P0 | ✅ 已实现 | 实时显示压缩百分比和进度 |
| 压缩历史记录 | P0 | ✅ 已实现 | 记录压缩历史，支持查看和删除 |
| 视频预览 | P0 | ✅ 已实现 | 压缩前后可预览视频 |
| 压缩结果对比 | P0 | ✅ 已实现 | 显示压缩前后大小对比和压缩比 |

### 2.2 扩展功能

| 功能 | 优先级 | 代码状态 | 说明 |
|------|--------|----------|------|
| 后台压缩 | P1 | ✅ 已实现 | 支持后台持续压缩 |
| 输出目录设置 | P1 | ✅ 已实现 | 自定义压缩后视频保存位置 |
| 保存到相册 | P1 | ✅ 已实现 | 压缩完成后保存到系统相册 |
| 视频分享 | P1 | ✅ 已实现 | 压缩完成后直接分享 |
| 删除原文件 | P2 | ✅ 已实现 | 压缩完成后可选择删除原文件 |
| 默认参数记忆 | P1 | ✅ 已实现 | 记住用户上次使用的压缩参数 |

### 2.3 待实现功能

| 功能 | 优先级 | 代码状态 | 说明 |
|------|--------|----------|------|
| 远程视频压缩 | P1 | ❌ 未实现 | 通过 URL 下载视频后压缩 |
| 压缩预设模板 | P2 | ❌ 未实现 | 预设配置：微信/抖音/邮件等场景 |
| 多语言支持 | P2 | ❌ 未实现 | 中英文切换 |

### 2.4 辅助功能

| 功能 | 优先级 | 代码状态 | 说明 |
|------|--------|----------|------|
| 深色主题 | P0 | ✅ 已实现 | 深色为主的主题风格 |
| 视频信息展示 | P1 | ✅ 已实现 | 显示分辨率、时长、大小、编码、码率、帧率 |
| 压缩取消 | P1 | ✅ 已实现 | 支持中断压缩任务 |
| 错误提示 | P1 | ✅ 已实现 | 压缩失败时给出原因 |
| 清除缓存 | P1 | ✅ 已实现 | 清除缩略图等缓存文件 |
| 任务状态管理 | P1 | ✅ 已实现 | pending/queued/running/completed/failed/cancelled/skipped |

---

## 三、功能详细说明

### 3.1 本地视频压缩

**入口**：首页 → 选择视频 → 配置参数 → 开始压缩

**流程**：
1. 点击「选择视频」按钮
2. 系统文件选择器打开，支持多选
3. 加载视频信息（分辨率、时长、大小、码率、帧率、旋转角度）
4. 显示视频缩略图
5. 配置压缩质量和分辨率
6. 点击「开始压缩」
7. 显示压缩进度（百分比）
8. 压缩完成展示结果（压缩后大小、压缩比）

**交互细节**：
- 视频缩略图展示
- 显示原始视频信息
- 预估压缩后大小（智能比特率：如果原视频比特率低于目标，使用原视频比特率）
- 压缩前可预览原视频

### 3.2 批量压缩（压缩队列）

**流程**：
1. 选择多个视频
2. 配置统一压缩参数
3. 加入压缩队列
4. 依次执行压缩
5. 显示队列进度（如 2/5）

**队列管理**：
- 支持查看队列列表
- 支持取消单个任务
- 任务状态：pending（等待中）/ queued（已排队）/ running（进行中）/ completed（已完成）/ failed（失败）/ cancelled（已取消）/ skipped（已跳过）

### 3.3 压缩质量设置

**预设档位**：

| 档位 | 码率 | 适用场景 |
|------|------|----------|
| Low | 1 Mbps | 聊天软件发送，省空间 |
| Medium | 2.5 Mbps | 日常分享，画质与大小平衡 |
| High | 5 Mbps | 保留较好画质 |
| Original | 保持原码率 | 仅调整分辨率 |
| Custom | 用户自定义 | 高级用户自定义码率 |

**自定义参数**：
- 视频码率：自定义 bps 值
- 音频码率：128 kbps（固定）

### 3.4 分辨率设置

**预设选项**：

| 分辨率 | 说明 |
|--------|------|
| 保持原分辨率 | 不改变分辨率 |
| 自定义高度 | 根据视频方向自动计算宽度 |

**智能处理**：
- 根据视频方向（横屏/竖屏）自动调整缩放逻辑
- 处理视频旋转元数据（0°/90°/180°/270°）

### 3.5 压缩进度显示

**进度信息**：
- 当前百分比（0-100%）
- 预估剩余时间

**进度条样式**：
- 圆形进度条（单个压缩）

### 3.6 压缩历史

**入口**：底部导航栏 → 历史

**记录内容**：
- 原文件名
- 压缩时间
- 压缩前后大小
- 压缩参数
- 输出路径

**操作**：
- 查看压缩后视频
- 视频预览
- 删除记录
- 清除全部历史

### 3.7 设置页面

**入口**：底部导航栏 → 设置

**配置项**：
| 设置项 | 说明 |
|--------|------|
| 默认压缩质量 | 选择默认的压缩质量档次 |
| 默认分辨率 | 选择默认的分辨率选项 |
| 输出目录 | 设置压缩后文件的保存位置 |
| 清除缓存 | 清除缩略图等缓存文件 |

### 3.8 视频预览

**功能**：
- 压缩前预览原始视频
- 压缩后预览压缩效果
- 支持播放控制（播放/暂停）

---

## 四、UI 设计规范

### 4.1 配色方案（基于代码 AppColors）

| 元素 | 颜色 | 色值 |
|------|------|------|
| 主背景 | 深黑色 | #0D0D0D |
| 次背景/表面 | 深灰色 | #1A1A1A |
| 卡片背景 | 灰黑色 | #262626 |
| 主色调 | 蓝色 | #2196F3 |
| 辅助蓝 | 浅蓝色 | #64B5F6 |
| 文字主色 | 白色 | #FFFFFF |
| 文字次色 | 灰色 | #B3B3B3 |
| 成功色 | 绿色 | #4CAF50 |
| 错误色 | 红色 | #F44336 |
| 警告色 | 橙色 | #FF9800 |

### 4.2 页面结构

**移动端**：
```
┌─────────────────────────────┐
│         顶部标题栏           │
├─────────────────────────────┤
│                             │
│         主内容区域           │
│                             │
│                             │
├─────────────────────────────┤
│  压缩(首页) │ 历史 │ 设置    │
└─────────────────────────────┘
```

**桌面端**（MacOS）：
- 支持窗口化操作
- 独立的桌面布局

### 4.3 主要页面

1. **首页（压缩）**：视频选择入口 + 压缩配置
2. **压缩进行页**：进度展示 + 取消按钮
3. **历史页**：压缩历史列表 + 详情查看
4. **设置页**：应用默认设置

---

## 五、技术实现

### 5.1 技术栈

| 类别 | 技术 | 说明 |
|------|------|------|
| 框架 | Flutter | 跨平台移动/桌面端框架 |
| 状态管理 | flutter_bloc | BLoC 模式 |
| 视频处理 | ffmpeg_kit_flutter_new | FFmpeg 移动端库 |
| 视频编码 | h264_videotoolbox (MacOS) / libx264 (Android) | 硬件/软件编码 |
| 视频探针 | FFprobeKit | 获取视频元数据 |
| 文件选择 | photo_manager / file_picker | 本地视频选择 |
| 视频播放 | video_player / chewie | 视频预览 |
| 存储 | shared_preferences / path_provider | 本地存储 |
| 后台任务 | flutter_foreground_task | 后台压缩支持 |
| 相册写入 | gal | 保存到系统相册 |

### 5.2 数据模型

**CompressTask（压缩任务）**：
- id: 任务唯一标识
- video: 视频信息
- config: 压缩配置
- status: 任务状态
- progress: 压缩进度
- compressedSize: 压缩后大小
- compressedWidth/Height: 压缩后分辨率
- errorMessage: 错误信息

**CompressConfig（压缩配置）**：
- quality: 画质等级（low/medium/high/original/custom）
- customBitrate: 自定义码率
- targetWidth/Height: 目标分辨率
- keepOriginalResolution: 是否保持原始分辨率

**VideoInfo（视频信息）**：
- path: 文件路径
- size: 文件大小
- duration: 时长
- width/height: 分辨率
- codec: 编码格式
- bitrate: 码率
- frameRate: 帧率
- rotation: 旋转角度

---

## 六、非功能需求

### 6.1 性能要求

| 指标 | 要求 |
|------|------|
| 启动时间 | < 2s |
| 内存占用 | 压缩时峰值 < 500MB |
| 崩溃率 | < 0.1% |

### 6.2 兼容性

| 平台 | 最低版本 |
|------|----------|
| Android | 5.0 (API 21) |
| iOS | 12.0 |
| macOS | 10.14+ |

### 6.3 支持格式

**输入格式**：
- MP4, MOV, AVI, MKV, FLV, WMV, WebM, 3GP

**输出格式**：
- MP4 (H.264)

---

## 七、数据指标

| 指标 | 目标 |
|------|------|
| 压缩成功率 | > 95% |
| 平均压缩比 | > 50% |
| 用户完成率 | > 80% |

---

## 八、版本规划

### 1.0.0（当前版本）

- [x] 本地视频压缩
- [x] 批量压缩
- [x] 压缩质量/分辨率设置
- [x] 进度显示
- [x] 压缩历史
- [x] 视频预览
- [x] 深色主题
- [x] 移动端支持
- [x] 桌面端支持（MacOS）

### 未来版本（待规划）

- [ ] 远程视频压缩（URL下载）
- [ ] 压缩预设模板
- [ ] 多语言支持
- [ ] Windows/Linux 桌面端