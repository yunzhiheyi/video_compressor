# 视频压缩 App 测试用例

## 一、测试范围

- 功能测试
- 性能测试
- 兼容性测试
- 异常测试
- UI测试
- 自动化测试（单元测试/BLoC测试/Widget测试）

---

## 二、自动化测试文件

### 2.1 测试文件结构

```
test/
├── unit/                          # 单元测试
│   ├── compress_config_test.dart # 压缩配置模型测试
│   ├── video_info_test.dart       # 视频信息模型测试
│   └── compress_task_test.dart    # 压缩任务模型测试
├── bloc/                          # BLoC 状态管理测试
│   ├── settings_bloc_test.dart    # 设置模块 BLoC 测试
│   └── history_bloc_test.dart     # 历史记录模块 BLoC 测试
├── widget/                         # Widget 组件测试
│   └── history_item_card_test.dart # 历史记录卡片组件测试
└── widget_test.dart               # 原有占位测试
```

### 2.2 自动化测试用例清单

#### 单元测试 (Unit Tests)

##### CompressConfig 测试 (`test/unit/compress_config_test.dart`)

| ID | 测试用例 | 验证内容 |
|----|---------|---------|
| UT001 | 默认构造函数 | 验证默认使用中画质 |
| UT002 | 自定义配置创建 | 验证可创建完整配置 |
| UT003 | bitrate - Low | 返回 1 Mbps |
| UT004 | bitrate - Medium | 返回 2.5 Mbps |
| UT005 | bitrate - High | 返回 5 Mbps |
| UT006 | bitrate - Original | 返回 0 |
| UT007 | bitrate - Custom | 使用自定义值 |
| UT008 | qualityLabel | 各画质对应标签文本 |
| UT009 | copyWith | 复制并修改属性 |
| UT010 | JSON 序列化 | toJson/fromJson |
| UT011 | Equatable | 相等性判断 |

##### VideoInfo 测试 (`test/unit/video_info_test.dart`)

| ID | 测试用例 | 验证内容 |
|----|---------|---------|
| UT101 | 基本信息创建 | 验证所有属性正确 |
| UT102 | resolution - 正常 | 1920×1080 |
| UT103 | resolution - 旋转90° | 交换宽高显示 |
| UT104 | resolution - 旋转270° | 交换宽高显示 |
| UT105 | sizeFormatted - B | 字节格式化 |
| UT106 | sizeFormatted - KB | KB格式化 |
| UT107 | sizeFormatted - MB | MB格式化 |
| UT108 | sizeFormatted - GB | GB格式化 |
| UT109 | durationFormatted - 正常 | 05:30 |
| UT110 | durationFormatted - 有小时 | 01:30:45 |
| UT111 | JSON 序列化 | toJson/fromJson |
| UT112 | copyWith | 复制并修改属性 |

##### CompressTask 测试 (`test/unit/compress_task_test.dart`)

| ID | 测试用例 | 验证内容 |
|----|---------|---------|
| UT201 | 任务创建 | 验证基本属性 |
| UT202 | isComplete | 完成状态判断 |
| UT203 | isFailed | 失败状态判断 |
| UT204 | isRunning | 进行中状态判断 |
| UT205 | isPending | 等待中状态判断 |
| UT206 | isQueued | 已排队状态判断 |
| UT207 | isSkipped | 已跳过状态判断 |
| UT208 | compressionRatio | 压缩比计算 |
| UT209 | originalResolution | 原始分辨率 |
| UT210 | compressedResolution | 压缩后分辨率 |
| UT211 | copyWith | 复制并修改属性 |
| UT212 | JSON 序列化 | toJson/fromJson |

#### BLoC 测试

##### SettingsBloc 测试 (`test/bloc/settings_bloc_test.dart`)

| ID | 测试用例 | 验证内容 |
|----|---------|---------|
| BL001 | 初始状态 | 默认值验证 |
| BL002 | LoadSettings | 加载所有设置 |
| BL003 | SetDefaultQuality | 更新默认质量 |
| BL004 | SetDefaultResolution | 更新默认分辨率 |
| BL005 | ClearCache | 清除缓存 |

##### HistoryBloc 测试 (`test/bloc/history_bloc_test.dart`)

| ID | 测试用例 | 验证内容 |
|----|---------|---------|
| BL101 | 初始状态 | 空列表验证 |
| BL102 | LoadHistory | 加载历史记录 |
| BL103 | LoadHistory - 空 | 空数据处理 |
| BL104 | ClearHistory | 清空所有记录 |
| BL105 | DeleteHistoryItem | 删除单条记录 |
| BL106 | AddHistoryItem | 添加新记录 |

##### State 单元测试

| ID | 测试用例 | 验证内容 |
|----|---------|---------|
| ST001 | SettingsState 默认值 | 各字段默认值 |
| ST002 | SettingsState copyWith | 状态更新 |
| ST003 | HistoryState 默认值 | 空列表 |
| ST004 | HistoryItem compressionRatio | 压缩比计算 |
| ST005 | HistoryItem durationFormatted | 时长格式化 |
| ST006 | HistoryItem bitrate 格式化 | Mbps/Kbps 显示 |

#### Widget 测试

##### HistoryItemCard 测试 (`test/widget/history_item_card_test.dart`)

| ID | 测试用例 | 验证内容 |
|----|---------|---------|
| WT001 | 显示视频名称 | 文本验证 |
| WT002 | 显示压缩前后大小 | Before/After 标签 |
| WT003 | 显示压缩比 | -50% 格式 |
| WT004 | 显示日期 | 格式化日期 |
| WT005 | 点击事件 | onTap 回调 |
| WT006 | 压缩比0% | 边界情况 |
| WT007 | formatSize 工具 | 字节格式化 |
| WT008 | formatDate 工具 | 日期格式化 |

---

## 三、功能测试用例

### 3.1 本地视频选择

| ID | 用例名称 | 前置条件 | 测试步骤 | 预期结果 |
|----|----------|----------|----------|----------|
| TC001 | 选择单个视频 | 应用已安装 | 1. 点击「选择视频」2. 选择一个 MP4 文件 | 视频加载成功，显示缩略图和信息 |
| TC002 | 选择多个视频 | 应用已安装 | 1. 点击「选择视频」2. 选择 3 个视频文件 | 3 个视频都加载成功，显示列表 |
| TC003 | 选择超大视频 | - | 1. 选择 > 2GB 的视频文件 | 加载成功，显示预估压缩时间 |
| TC004 | 选择不支持格式 | - | 1. 选择 .txt 文件 | 提示「不支持的文件格式」 |
| TC005 | 取消选择 | - | 1. 点击「选择视频」2. 点击取消 | 返回首页，无变化 |
| TC006 | 重新选择视频 | 已选择视频 | 1. 点击「重新选择」2. 选择新视频 | 原视频被替换为新视频 |

### 3.2 压缩配置

| ID | 用例名称 | 前置条件 | 测试步骤 | 预期结果 |
|----|----------|----------|----------|----------|
| TC101 | 选择低质量 | 已选择视频 | 1. 质量选择「低」| 显示预估压缩后大小，码率显示 1Mbps |
| TC102 | 选择高质量 | 已选择视频 | 1. 质量选择「高」| 显示预估压缩后大小，码率显示 5Mbps |
| TC103 | 自定义码率 | 已选择视频 | 1. 选择「自定义」2. 设置码率 3Mbps | 码率配置成功 |
| TC104 | 选择 720P 分辨率 | 已选择视频 | 1. 分辨率选择「720P」| 分辨率配置为 1280×720 |
| TC105 | 自定义分辨率 | 已选择视频 | 1. 选择「自定义」2. 输入 800×600 | 分辨率配置成功 |
| TC106 | 分辨率高于原视频 | 原视频 480P | 1. 选择 1080P | 提示「目标分辨率高于原视频，建议选择原分辨率」 |
| TC107 | 预设配置-微信 | 已选择视频 | 1. 选择预设「微信」| 自动配置适合微信发送的参数 |
| TC108 | 保存自定义预设 | 已配置参数 | 1. 点击「保存为预设」2. 输入名称 | 预设保存成功，下次可选择 |

### 3.3 压缩执行

| ID | 用例名称 | 前置条件 | 测试步骤 | 预期结果 |
|----|----------|----------|----------|----------|
| TC201 | 单视频压缩 | 已配置参数 | 1. 点击「开始压缩」| 开始压缩，显示进度条 |
| TC202 | 压缩进度更新 | 压缩进行中 | 观察 | 进度百分比实时更新 |
| TC203 | 压缩完成 | 压缩进行中 | 等待完成 | 显示完成状态，压缩前后大小对比 |
| TC204 | 取消压缩 | 压缩进行中 | 1. 点击「取消」| 压缩停止，生成临时文件被清理 |
| TC205 | 压缩失败-空间不足 | 存储空间不足 | 1. 开始压缩 | 提示「存储空间不足」，压缩失败 |
| TC206 | 压缩失败-视频损坏 | 视频文件损坏 | 1. 开始压缩 | 提示「视频文件损坏或格式不支持」 |
| TC207 | 后台压缩 | 压缩进行中 | 1. 切换到后台 | 压缩继续进行（Android需前台服务） |
| TC208 | 压缩后预览 | 压缩完成 | 1. 点击「预览」| 播放压缩后的视频 |
| TC209 | 压缩后分享 | 压缩完成 | 1. 点击「分享」| 弹出系统分享菜单 |
| TC210 | 压缩后删除原文件 | 压缩完成 | 1. 勾选「删除原文件」2. 确认 | 原文件被删除，仅保留压缩后文件 |

### 3.4 批量压缩

| ID | 用例名称 | 前置条件 | 测试步骤 | 预期结果 |
|----|----------|----------|----------|----------|
| TC301 | 批量选择视频 | - | 1. 选择 5 个视频 | 5 个视频都加入列表 |
| TC302 | 批量压缩队列 | 已选 5 个视频 | 1. 开始压缩 | 按顺序依次压缩，显示队列进度 1/5 |
| TC303 | 批量压缩-取消单个 | 批量压缩中 | 1. 点击列表中某任务的「取消」| 该任务取消，其他继续 |
| TC304 | 批量压缩-全部取消 | 批量压缩中 | 1. 点击「全部取消」| 所有任务停止 |
| TC305 | 批量压缩-部分失败 | 批量压缩中 | 模拟某视频损坏 | 失败视频标记错误，其他继续 |
| TC306 | 批量压缩-全部完成 | 批量压缩中 | 等待完成 | 显示汇总结果，成功X个，失败X个 |

### 3.5 远程视频压缩（待实现）

| ID | 用例名称 | 前置条件 | 测试步骤 | 预期结果 |
|----|----------|----------|----------|----------|
| TC401 | 下载直链视频 | - | 1. 输入 .mp4 直链 URL | 开始下载，显示下载进度 |
| TC402 | 下载完成后压缩 | 下载完成 | 自动进入压缩流程 | 压缩正常进行 |
| TC403 | 无效URL | - | 1. 输入无效 URL | 提示「URL 无效」 |

### 3.6 压缩历史

| ID | 用例名称 | 前置条件 | 测试步骤 | 预期结果 |
|----|----------|----------|----------|----------|
| TC501 | 查看历史列表 | 有压缩记录 | 1. 进入历史页面 | 显示压缩历史列表 |
| TC502 | 历史详情 | 有压缩记录 | 1. 点击某条记录 | 显示详细信息（参数、大小对比） |
| TC503 | 使用历史参数重新压缩 | 有压缩记录 | 1. 点击「重新压缩」| 使用相同参数压缩新视频 |
| TC504 | 删除历史记录 | 有压缩记录 | 1. 滑动删除 | 记录被删除 |
| TC505 | 清空历史 | 有压缩记录 | 1. 点击「清空历史」| 所有记录被删除 |
| TC506 | 打开压缩文件 | 有压缩记录 | 1. 点击「打开文件」| 使用系统播放器打开 |

### 3.7 设置

| ID | 用例名称 | 前置条件 | 测试步骤 | 预期结果 |
|----|----------|----------|----------|----------|
| TC601 | 修改默认输出目录 | - | 1. 修改输出目录 | 后续压缩输出到新目录 |
| TC602 | 修改默认质量 | - | 1. 设置默认质量为「中」| 新压缩任务默认使用中等质量 |
| TC603 | 修改默认分辨率 | - | 1. 设置默认分辨率为 720P | 新压缩任务默认使用 720P |
| TC604 | 清除缓存 | 有缓存 | 1. 点击「清除缓存」| 临时文件被清理，显示释放空间 |

---

## 四、性能测试用例

| ID | 用例名称 | 测试条件 | 测试方法 | 预期结果 |
|----|----------|----------|----------|----------|
| PT001 | 压缩速度 | 1080P 5分钟视频 | 记录压缩耗时 | 压缩比 > 1:10（如 50 秒压缩 5 分钟视频）|
| PT002 | 内存占用 | 压缩 500MB 视频 | 监控内存峰值 | 峰值 < 500MB |
| PT003 | CPU 占用 | 压缩进行中 | 监控 CPU | CPU < 80%，不影响其他应用 |
| PT004 | 电量消耗 | 连续压缩 1 小时 | 记录电量消耗 | 电量消耗 < 20% |
| PT005 | 启动时间 | 冷启动 | 记录启动耗时 | < 2 秒 |
| PT006 | 批量压缩稳定性 | 连续压缩 20 个视频 | 观察 | 无崩溃，无内存泄漏 |
| PT007 | 大文件处理 | 压缩 2GB 视频 | 观察 | 压缩正常完成 |
| PT008 | 低端机性能 | 低端 Android 设备 | 压缩测试 | 功能正常，可接受的速度 |

---

## 五、兼容性测试用例

### 5.1 设备兼容性

| ID | 设备类型 | 系统版本 | 测试内容 |
|----|----------|----------|----------|
| CT001 | iPhone 15 | iOS 17 | 全功能测试 |
| CT002 | iPhone 12 | iOS 16 | 全功能测试 |
| CT003 | iPhone X | iOS 15 | 全功能测试 |
| CT004 | Pixel 8 | Android 14 | 全功能测试 |
| CT005 | Samsung S23 | Android 13 | 全功能测试 |
| CT006 | 小米 13 | MIUI 14 | 全功能测试 |
| CT007 | 华为 Mate 50 | HarmonyOS | 全功能测试 |
| CT008 | 低端 Android | Android 8 | 基础功能测试 |

### 5.2 视频格式兼容性

| ID | 格式 | 测试内容 | 预期结果 |
|----|------|----------|----------|
| CF001 | MP4 (H.264) | 压缩测试 | 支持 |
| CF002 | MP4 (H.265) | 压缩测试 | 支持 |
| CF003 | MOV | 压缩测试 | 支持 |
| CF004 | MKV | 压缩测试 | 支持 |
| CF005 | AVI | 压缩测试 | 支持 |
| CF006 | WebM | 压缩测试 | 支持 |
| CF007 | FLV | 压缩测试 | 支持 |
| CF008 | 4K 视频 | 压缩测试 | 支持（可能较慢）|
| CF009 | 60fps 视频 | 压缩测试 | 支持 |
| CF010 | HDR 视频 | 压缩测试 | 支持（转 SDR）|

---

## 六、异常测试用例

| ID | 用例名称 | 测试步骤 | 预期结果 |
|----|----------|----------|----------|
| ET001 | 存储空间不足 | 压缩大文件，存储快满 | 提示空间不足，压缩失败 |
| ET002 | 压缩中断电 | 压缩进行中断电（模拟）| 临时文件被清理，无残留 |
| ET003 | 网络断开 | 下载远程视频中断网 | 提示网络错误，支持断点续传 |
| ET004 | 权限被拒绝 | 拒绝存储权限 | 提示需要权限，引导去设置 |
| ET005 | 文件被删除 | 压缩时原文件被其他应用删除 | 提示文件不存在，压缩失败 |
| ET006 | 低电量 | 电量 < 5% 时压缩 | 提示电量过低，建议充电后操作 |
| ET007 | 并发压缩限制 | 同时开始 5 个压缩任务 | 限制为 2 个并发，其余排队 |
| ET008 | 重复点击 | 快速多次点击「开始压缩」| 只启动一个压缩任务 |
| ET009 | 内存不足 | 后台多应用占用内存 | 优雅降级，不崩溃 |
| ET010 | 输出目录不存在 | 自定义目录被删除 | 自动创建或提示重新选择 |

---

## 七、UI 测试用例

| ID | 用例名称 | 测试内容 | 预期结果 |
|----|----------|----------|----------|
| UI001 | 深色主题显示 | 检查所有页面 | 黑色背景，蓝色强调色 |
| UI002 | 横屏适配 | 旋转屏幕 | 布局自适应 |
| UI003 | 小屏幕适配 | 5 寸屏手机 | 内容完整显示，可滚动 |
| UI004 | 大屏幕适配 | 平板设备 | 布局合理，无拉伸 |
| UI005 | 文字截断 | 长文件名 | 显示省略号，可查看完整 |
| UI006 | 进度条动画 | 压缩进行中 | 进度条平滑动画 |
| UI007 | 按钮状态 | 点击按钮 | 有按压反馈效果 |
| UI008 | 空状态 | 无历史记录 | 显示空状态提示 |
| UI009 | 错误提示 | 各种错误场景 | 提示友好，带图标 |
| UI010 | 加载状态 | 数据加载中 | 显示加载指示器 |

---

## 八、运行测试命令

### 运行所有测试
```bash
flutter test
```

### 运行特定模块测试
```bash
# 单元测试
flutter test test/unit/

# BLoC 测试
flutter test test/bloc/

# Widget 测试
flutter test test/widget/
```

### 运行单个测试文件
```bash
flutter test test/unit/compress_config_test.dart
```

### 生成测试覆盖率报告
```bash
flutter test --coverage
```

---

## 九、测试覆盖率目标

| 模块 | 目标覆盖率 |
|------|-----------|
| 数据模型 | 90%+ |
| BLoC | 85%+ |
| Widget | 70%+ |
| 整体 | 80%+ |

---

## 十、未来测试扩展

- [ ] LocalCompressBloc 测试（压缩流程）
- [ ] FFmpegService 单元测试
- [ ] 端到端集成测试
- [ ] 性能基准测试
- [ ] 快照测试（UI 变化检测）